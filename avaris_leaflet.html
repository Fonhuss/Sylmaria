
<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sortskærerne – Rejsetider (Leaflet)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  html, body { height: 100%; margin: 0; }
  #map { width: 100%; height: 100%; background: #e5dcc7; }
  .panel {
    position: absolute; top: 10px; left: 10px; z-index: 1000;
    background: rgba(255,255,255,0.95); padding: 10px 12px; border-radius: 12px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.15); font-family: system-ui, Segoe UI, Roboto, sans-serif; max-width: 320px;
  }
  .panel h3 { margin: 0 0 8px; font-size: 16px; }
  .panel .row { display: flex; gap: 6px; align-items: center; margin: 6px 0; }
  .panel label { font-size: 12px; color: #333; }
  .panel select, .panel input { padding: 6px 8px; border-radius: 8px; border: 1px solid #ccc; font-size: 13px; width: 100%; }
  .panel button { padding: 8px 10px; border-radius: 10px; border: 0; background: #111827; color: white; cursor: pointer; }
  .panel button.secondary { background: #e5e7eb; color: #111827; }
  .stats { font-size: 13px; margin-top: 8px; line-height: 1.35; }
  .pill { display:inline-block; padding:2px 8px; background:#111827; color:#fff; border-radius:999px; font-size:11px; }
  .hint { font-size: 11px; color: #555; margin-top: 6px; }
</style>
</head>
<body>
<div class="panel">
  <h3>Rejsetidsberegner</h3>
  <div class="row">
    <label>Rejsetype</label>
    <select id="mode">
      <option value="land-rolig">Land – rolig (29 km/dag)</option>
      <option value="land-normal" selected>Land – normal (38.6 km/dag)</option>
      <option value="land-haste">Land – haste (48.3 km/dag)</option>
      <option value="sea">Sø – skib (77 km/dag)</option>
    </select>
  </div>
  <div class="row">
    <label>Skala</label>
    <input type="number" id="kmPerPixel" step="0.001" value="0.20" />
  </div>
  <div class="row">
    <button id="btnReset">Nulstil</button>
    <button id="btnExport" class="secondary" title="Kopier rute til udklipsholder">Kopiér resultat</button>
  </div>
  <div class="stats" id="stats">
    <span class="pill">Tip</span> Klik to steder på kortet for at måle.
  </div>
  <div class="hint">Justér “Skala (km/pixel)” så målinger passer til dine kendte afstande (fx Aurora ↔ Glen Céledach = 283 km).</div>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
(async function() {
  // Image size (we need to know width/height). We'll load the image to get dimensions.
  const imgUrl = "map_avaris.png"; // the image will be next to the HTML in the sandbox path we save
  function loadImage(url){ return new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=url; }); }
  const img = await loadImage(imgUrl);
  const w = img.naturalWidth, h = img.naturalHeight;

  // Leaflet map with simple CRS
  const map = L.map('map', {
    crs: L.CRS.Simple,
    minZoom: -1,
    maxZoom: 2,
    attributionControl: false
  });
  const bounds = [[0,0], [h, w]];
  const image = L.imageOverlay(imgUrl, bounds).addTo(map);
  map.fitBounds(bounds);

  // State
  let points = [];
  let lineLayer = null;

  const kmInput = document.getElementById('kmPerPixel');
  const stats = document.getElementById('stats');
  const modeSel = document.getElementById('mode');

  const speeds = {
    "land-rolig": 29,
    "land-normal": 38.6,
    "land-haste": 48.3,
    "sea": 77
  };

  function fmtDays(d) {
    // show decimal with comma
    const exact = (Math.round(d*100)/100).toFixed(2).replace('.', ',');
    // round to nearest 0.5
    const half = Math.round(d*2)/2;
    // 1.5 -> 1½ otherwise use 'næsten X' if >= .65
    let approx;
    if (Math.abs(half - 1.5) < 0.001) approx = "1½ dage";
    else if (Math.abs(half - Math.round(half)) < 0.001) approx = `${half.toFixed(0)} dage`;
    else approx = `${half.toFixed(1).replace('.0','').replace('.',',')} dage`;
    // 'næsten' logic
    const nearIntUp = Math.ceil(d);
    const frac = d - Math.floor(d);
    let qual = approx;
    if (frac >= 0.65) qual = `næsten ${nearIntUp} dage`;
    return { exact, qual };
  }

  function updateStats() {
    if (points.length < 2) return;
    const kmPerPixel = parseFloat(kmInput.value || "0.2");
    const a = points[0], b = points[1];
    const dx = (b[1]-a[1]), dy = (b[0]-a[0]);
    const px = Math.sqrt(dx*dx + dy*dy);
    const km = px * kmPerPixel;
    const speed = speeds[modeSel.value];
    const days = km / speed;

    const { exact, qual } = fmtDays(days);

    stats.innerHTML = `
      <div><strong>Distance:</strong> ${km.toFixed(0)} km</div>
      <div><strong>Fart:</strong> ${speed} km/dag</div>
      <div><strong>Tid:</strong> ≈ ${exact} dage → <strong>${qual}</strong></div>
      <div style="margin-top:6px;font-size:12px;color:#555;">Klik “Kopiér resultat” for at kopiere som tekst.</div>
    `;

    if (lineLayer) lineLayer.remove();
    lineLayer = L.polyline(points, {weight: 3}).addTo(map);
  }

  function reset() {
    points = [];
    if (lineLayer) { lineLayer.remove(); lineLayer=null; }
    stats.innerHTML = '<span class="pill">Tip</span> Klik to steder på kortet for at måle.';
  }

  map.on('click', (e) => {
    if (points.length === 2) reset();
    points.push([e.latlng.lat, e.latlng.lng]);
    L.circleMarker(e.latlng, {radius: 4, weight:1}).addTo(map);
    if (points.length === 2) updateStats();
  });

  document.getElementById('btnReset').addEventListener('click', reset);

  document.getElementById('btnExport').addEventListener('click', async () => {
    if (points.length < 2) return;
    const kmPerPixel = parseFloat(kmInput.value || "0.2");
    const speed = speeds[modeSel.value];
    const dx = (points[1][1]-points[0][1]), dy=(points[1][0]-points[0][0]);
    const km = Math.sqrt(dx*dx + dy*dy) * kmPerPixel;
    const days = km / speed;
    const exact = (Math.round(days*100)/100).toFixed(2).replace('.', ',');
    const frac = days - Math.floor(days);
    let approx;
    if (Math.abs(days - 1.5) < 0.15) approx = "1½ dage";
    else if (frac >= 0.65) approx = `næsten ${Math.ceil(days)} dage`;
    else approx = `${(Math.round(days*2)/2).toString().replace('.',',')} dage`;

    const modeName = {
      "land-rolig":"Rolig",
      "land-normal":"Normal",
      "land-haste":"Haste",
      "sea":"Sø"
    }[modeSel.value];

    const text = `Distance: ${km.toFixed(0)} km\nFart: ${speed} km/dag (${modeName})\nTid: ≈ ${exact} dage → ${approx}`;
    try {
      await navigator.clipboard.writeText(text);
      stats.innerHTML += '<div style="font-size:12px;color:#0a7;">✔ Kopieret!</div>';
    } catch(e) {
      alert(text);
    }
  });

  // Draw a scale helper line with two draggable markers to calibrate km/pixel if desired.
  const m1 = L.marker([h-80, 40], {draggable:true}).addTo(map);
  const m2 = L.marker([h-80, 240], {draggable:true}).addTo(map);
  const helper = L.polyline([m1.getLatLng(), m2.getLatLng()], {dashArray:"4 4"}).addTo(map);
  function updateHelper(){
    helper.setLatLngs([m1.getLatLng(), m2.getLatLng()]);
    const p1 = m1.getLatLng(), p2=m2.getLatLng();
    const dx=(p2.lng-p1.lng), dy=(p2.lat-p1.lat);
    const px = Math.sqrt(dx*dx + dy*dy);
    helper.bindTooltip(`Kalibrering: ${px.toFixed(0)} px`, {permanent:true, direction:'top'}).openTooltip();
  }
  m1.on('drag', updateHelper); m2.on('drag', updateHelper); updateHelper();
})();
</script>
</body>
</html>
